<script>
  import AttemptPlayer from './AttemptPlayer.html'
  export let student
  export let tasks
  async function deleteAllData () {
    if (!confirm('Are you sure? This cannot be undone.')) return
    await app.service('students').remove(student._id)
  }
  $: events = app
    .service('events')
    .watch()
    .find({
      query: { studentId: student._id, $sort: { createdAt: 1 }, $limit: 10000 }
    })
  let taskIds
  let currentTaskId
  $: {
    const tasksSet = {}
    if ($events) {
      $events.data.forEach(e => {
        tasksSet[e.taskId] = true
      })
    }
    taskIds = Object.keys(tasksSet)
    currentTaskId = currentTaskId || taskIds[0]
  }
  $: someEvents = $events && $events.data.length > 0
</script>
<div class="studentInfo">
  <h1>
    Student #{student.serialNumber}<span class="actionButtons">
      <small
        >{#if $events} {taskIds.length} task{taskIds.length != 1 ? 's' : ''}
        {/if}</small
      >
      <button on:click="{deleteAllData}">
        Delete all data
      </button></span
    >
  </h1>

  <section>
    {#if $events} {#if someEvents}
    <nav>
      {#each taskIds as taskId}
      <button
        class="tab"
        class:active="{currentTaskId === taskId}"
        on:click="{() => {currentTaskId = taskId}}"
      >
        {tasks.find(t => t._id === taskId).title}
      </button>
      {/each}
    </nav>
    <AttemptPlayer
      {student}
      events="{$events.data.filter(e => e.taskId ===currentTaskId).map(e => ({...e, sec: +new Date(e.createdAt) / 1000}))}"
    />
    {:else}
    <p>No code received</p>
    {/if} {:else} ... {/if}
  </section>
</div>

<style>
  .studentInfo {
    width: 920px;
    margin-right: 30px;
    flex-shrink: 0.2;
  }
  .actionButtons {
    display: block;
    font-size: 1rem;
    position: absolute;
    right: 0;
    top: 0;
  }
  h1 {
    font-weight: normal;
    font-size: 140%;
    position: relative;
    border-bottom: 1px rgba(0, 0, 0, 0.3) solid;
  }
  .tab {
    background: none;
    border: none;
    border-bottom: transparent 2px solid;
  }
  .tab.active {
    font-weight: bold;
    border-bottom: royalblue 2px solid;
  }
</style>
